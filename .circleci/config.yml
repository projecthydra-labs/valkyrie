---
version: 2.1
jobs:
  build:
    machine: true
    parameters:
      gemfile:
        description: "Gemfile to run"
        default: "Gemfile"
        type: "string"
    environment:
      BUNDLE_GEMFILE: << parameters.gemfile >>
    steps:
      - checkout
      - run:
          name: Set ruby version to 2.6.1
          command: |
            rvm install 2.6.1
            echo . $(rvm 2.6.1 do rvm env --path) >> $BASH_ENV
      - run: rvm use 2.6.1
      - run:
          name: Install Docker Compose
          command: |
            curl -L https://github.com/docker/compose/releases/download/1.19.0/docker-compose-`uname -s`-`uname -m` > ~/docker-compose
            chmod +x ~/docker-compose
            sudo mv ~/docker-compose /usr/local/bin/docker-compose
      - run:
          name: Update bundler
          command: gem install bundler -v 1.17.2
      - restore_cache:
         keys:
           - bundle-{{ checksum "<< parameters.gemfile >>" }}-{{ checksum "valkyrie.gemspec" }}-4
           - bundle- # used if checksum fails
      - run: sudo apt-get update && sudo apt-get install -y libpq-dev
      - run:
          name: Set BUNDLE_GEMFILE
          command: export BUNDLE_GEMFILE=~/project/<< parameters.gemfile >>
      - run:
          name: Install dependencies
          command: bundle install --path=vendor/bundle --jobs 4 --retry 3
      - save_cache:
          key: bundle-{{ checksum "<< parameters.gemfile >>" }}-{{ checksum "valkyrie.gemspec" }}-4
          paths:
            - "vendor/bundle"
            - "gemfiles/vendor/bundle"
      - run:
          name: Run Rubocop
          command: bundle exec rake rubocop
      - run:
          name: Run Specs
          command: bundle exec rake docker:spec
      - store_artifacts:
          path: coverage
          destination: coverage
workflows:
  version: 2
  build:
    jobs:
      - build:
          gemfile: "gemfiles/activerecord_5_2.gemfile"
      - build:
          gemfile: "gemfiles/activerecord_6.gemfile"
      - build:
          gemfile: "gemfiles/activerecord_5_1.gemfile"
  nightly:
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - master
    jobs:
      - build
